import React, { useState } from "react";
import {
  ThemeProvider,
  CssBaseline,
  Container,
  Paper,
  Typography,
  Box,
  AppBar,
  Toolbar,
  Snackbar,
  Alert as MuiAlert,
  CircularProgress,
  Fade,
} from "@mui/material";
import { Analytics, Security, CloudDone } from "@mui/icons-material";
import theme from "./theme";
import PredictionForm from "./PredictionForm";
import PredictionResults from "./PredictionResults";
import { predictChurn } from "./services/api";
import { PredictionRequest, PredictionResponse } from "./types";

function App() {
  const [prediction, setPrediction] = useState<PredictionResponse | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState("");
  const [snackbarSeverity, setSnackbarSeverity] = useState<
    "success" | "error" | "info"
  >("info");

  const handlePrediction = async (formData: PredictionRequest) => {
    setLoading(true);
    setError(null);
    setPrediction(null);

    try {
      // Validaciones adicionales del lado del cliente
      if (formData.age < 18 || formData.age > 70) {
        throw new Error("La edad debe estar entre 18 y 70 aÃ±os");
      }

      if (
        formData.customer_satisfaction_score < 1 ||
        formData.customer_satisfaction_score > 10
      ) {
        throw new Error(
          "La puntuaciÃ³n de satisfacciÃ³n debe estar entre 1 y 10"
        );
      }

      const result = await predictChurn(formData);
      setPrediction(result);

      setSnackbarMessage("âœ… PredicciÃ³n completada exitosamente");
      setSnackbarSeverity("success");
      setSnackbarOpen(true);
    } catch (err) {
      console.error("Error en la peticiÃ³n:", err);
      const errorMessage =
        err instanceof Error
          ? err.message
          : "Error al conectar con el servidor";
      setError(errorMessage);

      setSnackbarMessage(`âŒ ${errorMessage}`);
      setSnackbarSeverity("error");
      setSnackbarOpen(true);
    } finally {
      setLoading(false);
    }
  };

  const handleCloseSnackbar = () => {
    setSnackbarOpen(false);
  };

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <Box
        sx={{
          flexGrow: 1,
          minHeight: "100vh",
          backgroundColor: "background.default",
        }}
      >
        <AppBar position="static" elevation={2}>
          <Toolbar>
            <Analytics sx={{ mr: 2, fontSize: 32 }} />
            <Typography
              variant="h5"
              component="div"
              sx={{ flexGrow: 1, fontWeight: 700 }}
            >
              ChurnInsight Platform
            </Typography>
            <Security sx={{ ml: 2, mr: 1 }} />
            <Typography variant="body2" sx={{ mr: 2 }}>
              AnÃ¡lisis Seguro
            </Typography>
            <CloudDone sx={{ ml: 1 }} />
          </Toolbar>
        </AppBar>

        <Container maxWidth="xl" sx={{ mt: 4, mb: 4 }}>
          <Fade in timeout={800}>
            <Paper elevation={6} sx={{ p: 4, borderRadius: 3 }}>
              <Box sx={{ textAlign: "center", mb: 4 }}>
                <Typography
                  variant="h3"
                  gutterBottom
                  sx={{
                    color: "primary.main",
                    fontWeight: "bold",
                    background:
                      "linear-gradient(45deg, #1976d2 30%, #42a5f5 90%)",
                    WebkitBackgroundClip: "text",
                    WebkitTextFillColor: "transparent",
                  }}
                >
                  ðŸŽ¯ PredicciÃ³n de Churn en FinTech
                </Typography>
                <Typography variant="h6" color="text.secondary" sx={{ mb: 2 }}>
                  Analiza el riesgo de abandono de tus clientes con IA avanzada
                </Typography>
                <Box
                  sx={{
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                    gap: 2,
                    flexWrap: "wrap",
                  }}
                >
                  <Typography variant="body2" color="text.secondary">
                    ðŸ”’ Seguro
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    â€¢
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    âš¡ RÃ¡pido
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    â€¢
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    ðŸŽ¨ Intuitivo
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    â€¢
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    ðŸ“Š Preciso
                  </Typography>
                </Box>
              </Box>

              {loading && (
                <Box sx={{ display: "flex", justifyContent: "center", my: 4 }}>
                  <CircularProgress size={60} thickness={4} />
                </Box>
              )}

              {!loading && (
                <>
                  <PredictionForm
                    onSubmit={handlePrediction}
                    loading={loading}
                  />
                  <PredictionResults prediction={prediction} error={error} />
                </>
              )}
            </Paper>
          </Fade>
        </Container>

        <Snackbar
          open={snackbarOpen}
          autoHideDuration={6000}
          onClose={handleCloseSnackbar}
          anchorOrigin={{ vertical: "bottom", horizontal: "center" }}
        >
          <MuiAlert
            onClose={handleCloseSnackbar}
            severity={snackbarSeverity}
            sx={{ width: "100%" }}
            elevation={6}
            variant="filled"
          >
            {snackbarMessage}
          </MuiAlert>
        </Snackbar>
      </Box>
    </ThemeProvider>
  );
}

export default App;
